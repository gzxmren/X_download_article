# X-Download-Article 项目架构说明

本项目是一个基于插件化设计的通用文章/推文下载器，主要针对 X (Twitter) 平台进行了深度优化。它能够抓取网页内容、下载图片、生成 Markdown/HTML，并支持导出为 PDF 和 EPUB 格式。

## 1. 目录结构概览

| 目录 | 说明 |
| :--- | :--- |
| `src/` | **核心源代码**。包含主程序、插件系统、逻辑处理模块等。 |
| `src/plugins/` | **插件目录**。针对不同站点（如 x.com）的特定提取逻辑。 |
| `src/templates/` | **模板目录**。用于生成导出 HTML 的 Jinja2 模板。 |
| `tests/` | **测试代码**。包含单元测试和集成测试。 |
| `docs/` | **项目文档**。架构设计、技术细节、路线图及更新日志。 |
| `input/` | **输入数据**。存放待处理的 URL 列表、浏览器 Cookies 等。 |
| `logs/` | **日志文件**。记录程序运行过程中的 INFO、ERROR 等信息。 |
| `venv/` | **虚拟环境**。存放项目依赖的 Python 库。 |

## 2. 核心执行程序

| 程序 | 类型 | 说明 |
| :--- | :--- | :--- |
| `src/main.py` | **主程序** | 下载器的核心入口。负责启动浏览器、加载插件、执行下载任务及导出文件。 |
| `run.sh` | **启动脚本** | 对 `main.py` 的简单封装，方便在 Linux 环境下快速一键运行下载任务。 |
| `src/helper.py` | **辅助工具** | 记录管理器。支持同步 `records.csv`（根据已下载目录重建索引）、查看统计信息、导出 URL。 |

## 3. 检测与调试程序

| 程序 | 类型 | 说明 |
| :--- | :--- | :--- |
| `src/diagnose_url.py` | **诊断工具** | 用于调试网页加载问题。它可以保存快照（截图）和 HTML 源码，帮助分析选择器为何失效。 |
| `src/debug_extractor.py` | **提取调试** | 专门用于在不重新下载的情况下，对本地已有的 HTML 源码测试提取器（Extractor）逻辑。 |
| `src/clean_urls.py` | **数据清洗** | 格式化并去重 `input/urls.txt` 中的链接。 |

## 4. 测试程序

| 程序 | 类型 | 说明 |
| :--- | :--- | :--- |
| `test.sh` | **测试启动器** | 运行项目中所有的 `pytest` 测试用例。 |
| `tests/unit/` | **单元测试** | 对逻辑组件（如路径清洗、配置加载）进行独立测试。 |
| `tests/integration/` | **集成测试** | 对完整流程（如从 URL 到文件保存）进行模拟测试。 |

## 5. 配置文件与数据文件

| 文件 | 类型 | 说明 |
| :--- | :--- | :--- |
| `config.yaml` | **用户配置** | **最重要**。配置超时时间、滚动次数、爬虫 UA 以及各站点的 CSS 选择器。 |
| `src/config.py` | **配置加载器** | 读取 `config.yaml` 并提供程序内部使用的单例配置对象。 |
| `requirements.txt` | **依赖列表** | 列出项目运行所需的 Python 库（如 Playwright, BeautifulSoup4）。 |
| `input/urls.txt` | **数据输入** | 存放需要下载的文章链接，支持 `#` 开头的注释。 |
| `input/cookies.txt` | **凭证数据** | 存放 Netscape 格式或 JSON 格式的浏览器 Cookies，用于绕过登录校验。 |

## 6. 核心逻辑模块说明 (`src/`)

*   **`record_manager.py`**: 负责维护 `records.csv`。记录每个 URL 的下载状态（成功/失败）、标题、作者和日期，防止重复下载。
*   **`plugin_manager.py`**: 插件分发器。根据 URL 自动匹配最适合的插件（如 XComPlugin）。
*   **`indexer.py`**: 自动生成索引。将所有已下载的文章组织成一个可搜索、带分页的网页索引。
*   **`exporter.py`**: 将 HTML 转换为高质量的 PDF 或 EPUB。
*   **`models.py`**: 定义了项目的数据结构（如 `ArticleMetadata`）。
